import r from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import e from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import o from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import t from"../../../call/index.js";import s from"../../../token.js";import{IAPPayType as n,ProrationMode as a}from"../../../../types/enum.js";import{apiResponse as i}from"../../../../utils/response.js";import{PAYMENT_APIS as d,APP_ID as p,PRORATION_MODE as c}from"../../../../constants.js";import{__generator as u}from'./../../../../external/tslib/tslib.es6.js';import l from"../../../../appEnv/getEnv.js";var m,_=(m=r((function(r,m,_,f){var E,h,j,I,R,A,v,w,y,P,T,b,D,C,S,M,N,O,U;return u(this,(function(u){switch(u.label){case 0:R=p,(A=new URLSearchParams).append("payType",m||n.SUBSCRIPTION),v=a.UNKNOW,_===c.IMMEDIATE_AND_CHARGE_FULL_PRICE&&(v=a.IMMEDIATE_AND_CHARGE_FULL_PRICE),_===c.DEFERRED&&(v=a.DEFERRED),A.append("prorationMode",v.toString()),A.append("appId",R),f&&A.append("method",f),w="",(null===(E=l())||void 0===E||null===(h=E.platform)||void 0===h?void 0:h.isIOS)?w="ios":(null===(j=l())||void 0===j||null===(I=j.platform)||void 0===I?void 0:I.isAndroid)&&(w="android"),A.append("os",w),A.append("productId",r),y={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},u.label=1;case 1:return u.trys.push([1,5,,6]),[4,s.getAccessToken().catch((function(r){throw i.error.loginRequired}))];case 2:return P=u.sent(),y.headers.authorization="Bearer ".concat(P),[4,fetch(d.CREATE_IAP_ORDER,o(e({method:"POST"},y),{body:A}))];case 3:return[4,u.sent().json()];case 4:if(!(T=u.sent()).data||!T.data.store||0!==T.err)throw i.error.createIAPOrderFailed(T.err);return b=T.data.store,D=T.data.orderId,C=b.sku,S=b.tranx_id,M=b.product_type,N=b.verify_url,O=b.subscription_data,U=b.uuid,[2,new Promise((function(r,e){t("IAP_REQUESTPAYMENT",{sku:C,tranx_id:S,product_type:M,verify_url:N,subscription_data:O,uuid:U},{success:function(){r({orderId:D})},fail:function(r){e(r)}})}))];case 5:throw u.sent();case 6:return[2]}}))})),function(r,e,o,t){return m.apply(this,arguments)});export{_ as default};
